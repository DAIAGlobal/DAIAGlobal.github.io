'use client';
import { AnimatePresence, motion } from "framer-motion";
import {
  useEffect,
  useMemo,
  useRef,
  useState,
  type ChangeEvent,
  type FormEvent,
  type KeyboardEvent,
  type ReactNode,
} from "react";

/* ================== marca ================== */
function BrandDAIA({ className }: { className?: string }) {
  return (
    <span aria-label="DAIA" className={className}>
      <span className="text-[#6C4CE5]">D</span>
      <span className="text-[#06B6D4]">A</span>
      <span className="text-[#F59E0B]">I</span>
      <span className="text-[#10B981]">A</span>
    </span>
  );
}

function BrandText({ text, className }: { text: string; className?: string }) {
  const parts = text.split(/DAIA/g);
  const pieces: ReactNode[] = [];
  parts.forEach((part, index) => {
    if (part) pieces.push(<span key={`text-${index}`}>{part}</span>);
    if (index < parts.length - 1) pieces.push(<BrandDAIA key={`brand-${index}`} />);
  });
  return <span className={className}>{pieces}</span>;
}

const MISION = "Investigar y desarrollar soluciones tecnologicas para que la innovacion sea accesible a todos.";

type FilialKey = 'labs' | 'data' | 'properties' | 'pharma' | 'global';

type Article = {
  id: string;
  title: string;
  excerpt: string;
  tag: string;
  date: string;
  href: string;
};

type DemoLabels = {
  title: string;
  description: string;
  pickFile: string;
  defaultSource: string;
  analyze: string;
  analyzing: string;
  metrics: {
    duration: string;
    silence: string;
    sentiment: string;
    talkRatio: string;
  };
  keywords: string;
  transcript: string;
  prepping: string;
  audioLabel: string;
  audioNote: string;
  downloadCsv: string;
  exportPdf: string;
  alertMessage: string;
};

type FilialModalLabels = {
  labsTitle: string;
  labsDescription: string;
  toggleShow: string;
  toggleHide: string;
  goApp: string;
  goAppHref: string;
  buy: string;
  buyHref: string;
  comingTitle: string;
  comingDescription: string;
  close: string;
  pricingNote: string;
};

type CheckoutLabels = {
  title: string;
  stepCounter: (step: number, total: number) => string;
  steps: [string, string, string];
  close: string;
  planName: string;
  priceSuffix: string;
  billing: {
    heading: string;
    fields: {
      companyName: string;
      taxId: string;
      country: string;
      address: string;
      city: string;
      state: string;
      zip: string;
      notes: string;
    };
    continue: string;
    processing: string;
  };
  account: {
    description: string;
    emailPlaceholder: string;
    send: string;
    sending: string;
  };
  success: {
    title: string;
    message: string;
    close: string;
  };
};

type LocaleDict = {
  nav: {
    home: string;
    about: string;
    mission: string;
    units: string;
    labs: string;
    contact: string;
    talk: string;
  };
  hero: {
    intro: string;
    seeUnits: string;
    buy: string;
    contact: string;
  };
  missionSection: {
    title: string;
    text: string;
    chips: string[];
  };
  about: {
    title: string;
    body: string;
    bullets: string[];
    focus: string;
    focusBadges: string[];
    focusLinePre: string;
    focusLinePost: string;
  };
  units: {
    title: string;
    subtitle: string;
    activeLabel: string;
    soonLabel: string;
    desc: {
      labs: string;
      data: string;
      props: string;
      pharma: string;
      global: string;
    };
  };
  what: {
    title: string;
    tech: { title: string; text: string };
    data: { title: string; text: string };
    re: { title: string; text: string };
    global: { title: string; text: string };
  };
  labs: {
    title: string;
    subtitle: string;
    intro: string;
    ctaNote: string;
    read: string;
    buy: string;
  };
  filialModal: FilialModalLabels;
  demo: DemoLabels;
  checkout: CheckoutLabels;
  contact: {
    title: string;
    name: string;
    email: string;
    message: string;
    send: string;
    sending: string;
  };
  footer: {
    developedBy: string;
    rights: string;
  };
};

const LABS_DEMO_RESULTS = {
  durationSec: 312,
  silenceRatio: 0.18,
  sentiment: "positivo",
  talkRatioAgent: 0.62,
  talkRatioCustomer: 0.38,
  keywords: ["cancelacion", "renovacion", "descuento", "demora", "satisfaccion"],
};

const LABS_DEMO_TRANSCRIPT = [
  { speaker: "Agente", text: "Hola, gracias por contactar a DAIA Labs. Vemos que estas evaluando la renovacion del servicio." },
  { speaker: "Cliente", text: "Si, queria confirmar si hay un descuento por renovar este trimestre." },
  { speaker: "Agente", text: "Podemos aplicar un descuento especial si confirmamos hoy mismo." },
  { speaker: "Cliente", text: "Genial, la demora interna fue por una cancelacion previa." },
  { speaker: "Agente", text: "Entiendo. Sumamos auditoria automatica de llamadas para asegurar calidad." },
  { speaker: "Cliente", text: "Eso ayuda mucho para detectar silencios largos en ventas." },
  { speaker: "Agente", text: "Exacto, la solucion marca silencios, emociones y keywords criticas." },
  { speaker: "Cliente", text: "Perfecto, avancemos con la renovacion y el descuento propuesto." },
  { speaker: "Agente", text: "Te enviamos la documentacion hoy junto con la demo final." },
  { speaker: "Cliente", text: "Quedo a la espera, gracias por la claridad." },
  { speaker: "Agente", text: "Un gusto ayudarte. Seguimos en contacto." },
];

type BillingState = {
  companyName: string;
  taxId: string;
  country: string;
  address: string;
  city: string;
  state: string;
  zip: string;
  notes: string;
};

export default function DAIAHoldingLanding() {
  const priceUSD = 500;
  const DEFAULT_FORM_ENDPOINT = "https://formspree.io/f/xrbajroz";
  const FORM_ENDPOINT = process.env.NEXT_PUBLIC_FORM_ENDPOINT || DEFAULT_FORM_ENDPOINT;
  const DEFAULT_CONTACT_EMAIL = "daiaglab@gmail.com";
  const CONTACT_EMAIL = process.env.NEXT_PUBLIC_CONTACT_EMAIL || DEFAULT_CONTACT_EMAIL;

  const [sending, setSending] = useState(false);
  const [sent, setSent] = useState<null | { ok: boolean; message: string }>(null);
  const [lang, setLang] = useState<"es" | "en">("es");
  const [checkoutOpen, setCheckoutOpen] = useState(false);
  const [selectedUnit, setSelectedUnit] = useState<FilialKey | null>(null);
  const [unitOpen, setUnitOpen] = useState(false);

  useEffect(() => {
    try {
      const saved = typeof window !== "undefined" ? window.localStorage.getItem("daia_lang") : null;
      if (saved === "en" || saved === "es") {
        setLang(saved);
        return;
      }
    } catch {
      // ignore
    }
    if (typeof navigator !== "undefined" && navigator.language?.toLowerCase().startsWith("en")) {
      setLang("en");
    }
  }, []);

  const isEN = lang === "en";

  const toggleLang = () => {
    setLang((prev) => {
      const next = prev === "en" ? "es" : "en";
      try {
        window.localStorage.setItem("daia_lang", next);
      } catch {
        // ignore
      }
      return next;
    });
  };

  const dict: LocaleDict = isEN
    ? {
        nav: {
          home: "Home",
          about: "About",
          mission: "Mission",
          units: "Subsidiaries",
          labs: "DAIA Labs",
          contact: "Contact",
          talk: "Let's Talk",
        },
        hero: {
          intro:
            "Innovation with purpose. We started in technology to build solutions that improve people's lives, and we keep evolving to meet new challenges.",
          seeUnits: "See subsidiaries",
          buy: "Buy",
          contact: "Contact",
        },
        missionSection: {
          title: "Our Mission",
          text: "Research and develop technological solutions so innovation is accessible to everyone.",
          chips: ["Access", "R&D", "Real impact"],
        },
        about: {
          title: "About us",
          body:
            "DAIA is an Uruguayan holding company created to scale solutions and capital. We evolved from N&B - InnoviNex - DAIA. We operate with an agile matrix and specialized units.",
          bullets: [
            "- Simple and effective corporate governance.",
            "- Decentralized execution by subsidiaries.",
            "- Long-term vision and diversification.",
          ],
          focus: "Focus 2025",
          focusBadges: ["Technology", "Real Estate", "Pharma / Research", "Global"],
          focusLinePre: "We're kicking off strong with ",
          focusLinePost: " while we prepare new subsidiaries.",
        },
        units: {
          title: "Subsidiaries",
          subtitle: "Currently active: ",
          activeLabel: "Operational",
          soonLabel: "Coming Soon",
          desc: {
            labs: "R&D, AI and software development. End-to-end delivery.",
            data: "Databases, dashboards and analytics.",
            props: "Real estate assets and rent management.",
            pharma: "Pharmaceutical and biotech research: formulation, analysis and preclinical development.",
            global: "Export and investments from Free Trade Zone.",
          },
        },
        what: {
          title: "What we do",
          tech: { title: "Technology", text: "Automation, apps and support." },
          data: { title: "Data", text: "Modeling, SQL and BI." },
          re: { title: "Real Estate", text: "Rent management and capex." },
          global: { title: "Global", text: "International invoicing and trade." },
        },
        labs: {
          title: "DAIA Labs",
          subtitle: "Articles and updates",
          intro: "Articles about how we build products, AI models and agile delivery from Montevideo to the region.",
          ctaNote: "Want to activate DAIA Labs in your organization? Meet our Pro plan.",
          read: "Read",
          buy: "Buy",
        },
        filialModal: {
          labsTitle: "DAIA Labs - AI call auditing",
          labsDescription:
            "Call auditing with AI, silence and emotion detection, keyword spotting and automated reports for CX leaders.",
          toggleShow: "Hide demo",
          toggleHide: "Try demo",
          goApp: "Go to the app",
          goAppHref: "https://app.daialabs.dev",
          buy: "Buy",
          buyHref: "https://app.daialabs.dev/checkout?plan=pro",
          comingTitle: "Coming soon",
          comingDescription: "We are preparing the launch of this subsidiary. Leave us a reminder and we will let you know.",
          close: "Close",
          pricingNote: "* We do not show prices on the landing. The external checkout details the plan.",
        },
        demo: {
          title: "Demo - Auditing",
          description: "Upload a sample audio or use the preloaded demo to simulate a full analysis.",
          pickFile: "Select file (.wav, .mp3, .m4a)",
          defaultSource: "Preloaded demo",
          analyze: "Analyze",
          analyzing: "Analyzing...",
          metrics: {
            duration: "Duration",
            silence: "Silence",
            sentiment: "Sentiment",
            talkRatio: "Talk ratio",
          },
          keywords: "Detected keywords",
          transcript: "Transcript (demo)",
          prepping: "Preparing demo results...",
          audioLabel: "Demo call playback",
          audioNote: "(demo)",
          downloadCsv: "Download CSV",
          exportPdf: "Export PDF",
          alertMessage: "Demo function",
        },
        checkout: {
          title: "Checkout - DAIA Labs",
          stepCounter: (step: number, total: number) => `Step ${step} of ${total}`,
          steps: ["Billing", "Account", "Confirmation"],
          close: "Close",
          planName: "Pro plan",
          priceSuffix: "/month",
          billing: {
            heading: "Pro plan",
            fields: {
              companyName: "Company name",
              taxId: "Tax ID",
              country: "Country",
              address: "Address",
              city: "City",
              state: "State / Province",
              zip: "Zip code",
              notes: "Additional notes (optional)",
            },
            continue: "Continue to payment",
            processing: "Processing...",
          },
          account: {
            description: "Enter your email. We will send you a link to validate your account (no password).",
            emailPlaceholder: "Company email",
            send: "Send link",
            sending: "Sending...",
          },
          success: {
            title: "All set!",
            message: "We sent you a link to validate your account. Once inside, set your new password.",
            close: "Close",
          },
        },
        contact: {
          title: "Contact",
          name: "Name",
          email: "Email",
          message: "Message",
          send: "Send",
          sending: "Sending...",
        },
        footer: {
          developedBy: "Developed by",
          rights: "All rights reserved.",
        },
      }
    : {
        nav: {
          home: "Inicio",
          about: "Quienes somos",
          mission: "Vision",
          units: "Filiales",
          labs: "DAIA Labs",
          contact: "Contacto",
          talk: "Hablemos",
        },
        hero: {
          intro:
            "Innovacion con proposito. Nacimos en tecnologia para crear soluciones que mejoran la vida de las personas y seguimos evolucionando para acompanarlas en cada desafio.",
          seeUnits: "Ver filiales",
          buy: "Comprar",
          contact: "Contacto",
        },
        missionSection: {
          title: "Nuestra mision",
          text: "Investigar y desarrollar soluciones tecnologicas para que la innovacion sea accesible a todos.",
          chips: ["Acceso", "I+D", "Impacto real"],
        },
        about: {
          title: "Quienes somos",
          body:
            "DAIA es un holding uruguayo creado para escalar soluciones y capital. Evolucionamos de N&B - InnoviNex - DAIA. Operamos con una matriz agil y unidades especializadas.",
          bullets: [
            "- Gobernanza corporativa simple y efectiva.",
            "- Ejecucion descentralizada por filiales.",
            "- Vision de largo plazo y diversificacion.",
          ],
          focus: "Foco 2025",
          focusBadges: ["Tecnologia", "Real Estate", "Pharma / Investigacion", "Global"],
          focusLinePre: "Arrancamos fuerte con ",
          focusLinePost: " mientras preparamos el aterrizaje de nuevas filiales.",
        },
        units: {
          title: "Filiales",
          subtitle: "Hoy operativa: ",
          activeLabel: "Operativa",
          soonLabel: "Proximamente",
          desc: {
            labs: "I+D, IA y desarrollo de software. Delivery end-to-end.",
            data: "Bases de datos, tableros y analitica.",
            props: "Activos inmobiliarios y gestion de renta.",
            pharma: "Investigacion farmaceutica y biotech: formulacion, analisis y desarrollo preclinico.",
            global: "Exportacion e inversiones desde Zona Franca.",
          },
        },
        what: {
          title: "Que hacemos",
          tech: { title: "Tecnologia", text: "Automatizacion, apps y soporte." },
          data: { title: "Data", text: "Modelado, SQL y BI." },
          re: { title: "Real Estate", text: "Gestion de renta y capex." },
          global: { title: "Global", text: "Facturacion internacional y trade." },
        },
        labs: {
          title: "DAIA Labs",
          subtitle: "Articulos y novedades",
          intro: "Articulos y novedades sobre como construimos productos, modelos de IA y delivery agil desde Montevideo hacia la region.",
          ctaNote: "Queres activar DAIA Labs en tu organizacion? Conoce nuestro plan Pro.",
          read: "Leer",
          buy: "Comprar",
        },
        filialModal: {
          labsTitle: "DAIA Labs - Auditoria de llamadas con IA",
          labsDescription:
            "Auditoria de conversaciones con IA, deteccion de silencios, emociones y keywords claves, ademas de reportes automaticos para tus lideres de CX.",
          toggleShow: "Ocultar demo",
          toggleHide: "Probar demo",
          goApp: "Ir a la app",
          goAppHref: "https://app.daialabs.dev",
          buy: "Comprar",
          buyHref: "https://app.daialabs.dev/checkout?plan=pro",
          comingTitle: "Proximamente",
          comingDescription: "Estamos preparando el lanzamiento de esta filial. Podemos avisarte cuando salga.",
          close: "Cerrar",
          pricingNote: "* No mostramos precios en la landing. El checkout externo detalla el plan.",
        },
        demo: {
          title: "Demo - Auditoria",
          description: "Subi un audio de muestra o usa el demo pre-cargado para simular un analisis completo.",
          pickFile: "Elegir archivo (.wav, .mp3, .m4a)",
          defaultSource: "Demo pre-cargado",
          analyze: "Analizar",
          analyzing: "Analizando...",
          metrics: {
            duration: "Duracion",
            silence: "Silencio",
            sentiment: "Sentimiento",
            talkRatio: "Talk ratio",
          },
          keywords: "Keywords detectadas",
          transcript: "Transcript (demo)",
          prepping: "Preparando resultados demo...",
          audioLabel: "Reproduccion demo de llamada",
          audioNote: "(demo)",
          downloadCsv: "Descargar CSV",
          exportPdf: "Exportar PDF",
          alertMessage: "Funcion demo",
        },
        checkout: {
          title: "Checkout - DAIA Labs",
          stepCounter: (step: number, total: number) => `Paso ${step} de ${total}`,
          steps: ["Facturacion", "Cuenta", "Confirmacion"],
          close: "Cerrar",
          planName: "Plan Pro",
          priceSuffix: "/mes",
          billing: {
            heading: "Plan Pro",
            fields: {
              companyName: "Nombre de la empresa",
              taxId: "RUT / CI",
              country: "Pais",
              address: "Direccion",
              city: "Ciudad",
              state: "Estado / Provincia",
              zip: "Codigo postal",
              notes: "Notas adicionales (opcional)",
            },
            continue: "Continuar a pago",
            processing: "Procesando...",
          },
          account: {
            description: "Ingresa tu email. Te enviaremos un enlace para validar tu cuenta (sin contrasena).",
            emailPlaceholder: "Email corporativo",
            send: "Enviar enlace",
            sending: "Enviando...",
          },
          success: {
            title: "Listo!",
            message: "Te enviamos un link para validar tu cuenta. Al ingresar desde ese link, defini tu nueva contrasena.",
            close: "Cerrar",
          },
        },
        contact: {
          title: "Contacto",
          name: "Nombre",
          email: "Email",
          message: "Mensaje",
          send: "Enviar",
          sending: "Enviando...",
        },
        footer: {
          developedBy: "Desarrollado por",
          rights: "Todos los derechos reservados.",
        },
      };

  const articles = useMemo<Article[]>(
    () =>
      isEN
        ? [
            {
              id: "art-01",
              title: "Frameworks to scale operational AI",
              excerpt: "How we implement production-ready machine learning pipelines for mid-market teams.",
              tag: "Applied AI",
              date: "Aug 2025",
              href: "#",
            },
            {
              id: "art-02",
              title: "Intelligent agents for back-office automation",
              excerpt: "Real use cases automating admin processes with internal copilots and agents.",
              tag: "Automation",
              date: "Jul 2025",
              href: "#",
            },
            {
              id: "art-03",
              title: "Data-first product delivery",
              excerpt: "Principles to co-create software and services with regulated clients using data loops.",
              tag: "Product",
              date: "Jun 2025",
              href: "#",
            },
            {
              id: "art-04",
              title: "Recommended analytics stack",
              excerpt: "The stack we use for data warehouses, semantic layers and real-time BI.",
              tag: "Data",
              date: "May 2025",
              href: "#",
            },
            {
              id: "art-05",
              title: "Building distributed delivery squads",
              excerpt: "Lessons learned while assembling remote squads for critical projects.",
              tag: "Squads",
              date: "Apr 2025",
              href: "#",
            },
          ]
        : [
            {
              id: "art-01",
              title: "Frameworks de IA con impacto operativo",
              excerpt: "Como montamos pipelines de machine learning productivos para equipos medianos.",
              tag: "IA aplicada",
              date: "Ago 2025",
              href: "#",
            },
            {
              id: "art-02",
              title: "Agentes inteligentes para automatizar back-office",
              excerpt: "Casos reales automatizando procesos administrativos con agentes y copilotos internos.",
              tag: "Automation",
              date: "Jul 2025",
              href: "#",
            },
            {
              id: "art-03",
              title: "Delivery de productos data-first",
              excerpt: "Principios para co-crear software y servicios con data en clientes regulados.",
              tag: "Producto",
              date: "Jun 2025",
              href: "#",
            },
            {
              id: "art-04",
              title: "Stack recomendado para analitica moderna",
              excerpt: "El stack que usamos para data warehouses, modelos semanticos y BI en tiempo real.",
              tag: "Data",
              date: "May 2025",
              href: "#",
            },
            {
              id: "art-05",
              title: "Como armamos squads distribuidos",
              excerpt: "Aprendizajes al crear equipos distribuidos para proyectos criticos.",
              tag: "Squads",
              date: "Abr 2025",
              href: "#",
            },
          ],
    [isEN]
  );

  async function handleSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault();
   )))